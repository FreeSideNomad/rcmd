{% extends 'layouts/base.html' %}

{% block title %}Settings - Command Bus E2E{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Settings</h1>
    <p class="text-gray-500 dark:text-gray-400">Configure worker and retry parameters</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Worker Configuration -->
    <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Worker Configuration</h2>
        <form id="worker-form" class="space-y-4">
            <div>
                <label for="visibility-timeout" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Visibility Timeout (seconds)</label>
                <input type="number" id="visibility-timeout" min="5" max="300" value="30" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How long before unacknowledged message is redelivered</p>
            </div>

            <div>
                <label for="concurrency" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Concurrency</label>
                <input type="number" id="concurrency" min="1" max="32" value="4" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Number of concurrent command processors</p>
            </div>

            <div>
                <label for="poll-interval" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Poll Interval (seconds)</label>
                <input type="number" id="poll-interval" min="0.1" max="10" step="0.1" value="1.0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How often to poll queue for new messages</p>
            </div>

            <div>
                <label for="batch-size" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Batch Size</label>
                <input type="number" id="batch-size" min="1" max="100" value="10" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Number of messages to fetch per poll</p>
            </div>

            <button type="submit" class="w-full px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Save Worker Settings
            </button>
        </form>
    </div>

    <!-- Retry Configuration -->
    <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Retry Configuration</h2>
        <form id="retry-form" class="space-y-4">
            <div>
                <label for="max-attempts" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Max Attempts</label>
                <input type="number" id="max-attempts" min="1" max="10" value="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Maximum retry attempts before moving to TSQ</p>
            </div>

            <div>
                <label for="backoff-schedule" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Backoff Schedule (seconds)</label>
                <input type="text" id="backoff-schedule" value="10, 60, 300" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Comma-separated delays in seconds for each retry attempt</p>
            </div>

            <button type="submit" class="w-full px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Save Retry Settings
            </button>
        </form>
    </div>
</div>

<!-- Runtime Configuration -->
<div class="mt-6">
    <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Runtime Mode</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
            Switch between asynchronous (default) and synchronous workers. Changes require restarting worker processes.
        </p>
        <form id="runtime-form" class="space-y-4">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-white">
                    <input type="radio" name="runtime-mode" value="async" class="w-4 h-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                    Async (non-blocking)
                </label>
                <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-white">
                    <input type="radio" name="runtime-mode" value="sync" class="w-4 h-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                    Sync (threaded workers)
                </label>
            </div>

            <div>
                <label for="thread-pool-size" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                    Sync Thread Pool Size
                </label>
                <input type="number" id="thread-pool-size" min="1" max="64" placeholder="Leave blank for default"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    Used only in sync mode. Leave empty to use automatic sizing.
                </p>
            </div>

            <div class="rounded-lg bg-yellow-50 border border-yellow-200 px-4 py-3 text-sm text-yellow-800 dark:bg-yellow-900 dark:border-yellow-700 dark:text-yellow-200">
                After saving runtime settings, restart all worker processes to apply the change.
            </div>

            <button type="submit" class="w-full px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Save Runtime Settings
            </button>
        </form>
    </div>
</div>

<!-- Success/Error Message -->
<div id="settings-message" class="hidden mt-4 p-4 rounded-lg"></div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { ApiClient } from '/static/src/api.js';

    const api = new ApiClient();

    const runtimeRadios = document.querySelectorAll('input[name="runtime-mode"]');
    const threadPoolInput = document.getElementById('thread-pool-size');

    async function loadConfig() {
        const config = await api.get('/config');
        if (config) {
            // Worker settings
            document.getElementById('visibility-timeout').value = config.worker.visibility_timeout;
            document.getElementById('concurrency').value = config.worker.concurrency;
            document.getElementById('poll-interval').value = config.worker.poll_interval;
            document.getElementById('batch-size').value = config.worker.batch_size;

            // Retry settings
            document.getElementById('max-attempts').value = config.retry.max_attempts;
            document.getElementById('backoff-schedule').value = config.retry.backoff_schedule.join(', ');

            // Runtime settings
            if (config.runtime) {
                const mode = config.runtime.mode || 'async';
                runtimeRadios.forEach((radio) => {
                    radio.checked = radio.value === mode;
                });
                threadPoolInput.value = config.runtime.thread_pool_size ?? '';
            }
        }
    }

    function showMessage(text, isError = false) {
        const div = document.getElementById('settings-message');
        div.textContent = text;
        div.className = `mt-4 p-4 rounded-lg ${isError
            ? 'bg-red-50 text-red-800 dark:bg-red-900 dark:text-red-300'
            : 'bg-green-50 text-green-800 dark:bg-green-900 dark:text-green-300'}`;
        div.classList.remove('hidden');
        setTimeout(() => div.classList.add('hidden'), 3000);
    }

    document.getElementById('worker-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            worker: {
                visibility_timeout: parseInt(document.getElementById('visibility-timeout').value),
                concurrency: parseInt(document.getElementById('concurrency').value),
                poll_interval: parseFloat(document.getElementById('poll-interval').value),
                batch_size: parseInt(document.getElementById('batch-size').value),
            }
        };
        const result = await api.put('/config', data);
        showMessage(result ? 'Worker settings saved!' : 'Failed to save', !result);
    });

    document.getElementById('retry-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const scheduleStr = document.getElementById('backoff-schedule').value;
        const schedule = scheduleStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        const data = {
            retry: {
                max_attempts: parseInt(document.getElementById('max-attempts').value),
                backoff_schedule: schedule,
            }
        };
        const result = await api.put('/config', data);
        showMessage(result ? 'Retry settings saved!' : 'Failed to save', !result);
    });

    document.getElementById('runtime-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const selected = document.querySelector('input[name="runtime-mode"]:checked');
        const mode = selected ? selected.value : 'async';
        const poolValue = threadPoolInput.value.trim();
        let threadPoolSize = null;
        if (poolValue !== '') {
            const parsed = parseInt(poolValue, 10);
            if (Number.isNaN(parsed) || parsed < 1 || parsed > 64) {
                showMessage('Thread pool size must be between 1 and 64', true);
                return;
            }
            threadPoolSize = parsed;
        }
        const result = await api.put('/config', {
            runtime: {
                mode,
                thread_pool_size: threadPoolSize,
            },
        });
        showMessage(
            result ? 'Runtime settings saved! Restart workers to apply changes.' : 'Failed to save runtime settings',
            !result
        );
    });

    loadConfig();
</script>
{% endblock %}
