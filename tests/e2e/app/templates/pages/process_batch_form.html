{% extends 'layouts/base.html' %}

{% block title %}Create Process Batch - Command Bus E2E{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Create Process Batch</h1>
    <p class="text-gray-500 dark:text-gray-400">Initiate a batch of Statement Report Processes</p>
</div>

<!-- Batch Form -->
<div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
    <form id="process-batch-form" class="space-y-6">
        <!-- Count -->
        <div>
            <label for="count" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Number of Processes</label>
            <input type="number" id="count" min="1" max="1000000" value="10" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Limit 1,000,000</p>
        </div>

        <!-- Date Range -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="from-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">From Date</label>
                <input type="date" id="from-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            </div>
            <div>
                <label for="to-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">To Date</label>
                <input type="date" id="to-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            </div>
        </div>

        <!-- Output Type -->
        <div>
            <label for="output-type" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Output Type</label>
            <select id="output-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="pdf">PDF Report</option>
                <option value="html">HTML Report</option>
                <option value="csv">CSV Data</option>
            </select>
        </div>

        <!-- Behavior Toggle -->
        <div class="border rounded-lg p-4 dark:border-gray-700">
            <label class="flex items-center gap-3 text-sm font-medium text-gray-900 dark:text-white">
                <input type="checkbox" id="behavior-enabled" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                Enable probabilistic behavior per step
            </label>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Configure chaos testing for StatementQuery, Aggregation, and Render steps.</p>

            <div id="behavior-sections" class="hidden mt-4 space-y-5">
                {% set steps = [
                    ('query', 'Statement Query'),
                    ('aggregation', 'Statement Aggregation'),
                    ('render', 'Statement Render')
                ] %}
                {% for key, label in steps %}
                <div class="border rounded-lg p-4 bg-gray-50 dark:bg-gray-700/30 dark:border-gray-600">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">{{ label }}</h3>
                        <span class="text-xs text-gray-500 dark:text-gray-400">Configure {{ label }} behavior</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Permanent Failure %</label>
                            <input type="number" min="0" max="100" step="0.1" id="{{ key }}-fail-permanent" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Transient Failure %</label>
                            <input type="number" min="0" max="100" step="0.1" id="{{ key }}-fail-transient" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Timeout %</label>
                            <input type="number" min="0" max="100" step="0.1" id="{{ key }}-timeout" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Min Duration (ms)</label>
                                <input type="number" min="0" id="{{ key }}-min-duration" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Max Duration (ms)</label>
                                <input type="number" min="0" id="{{ key }}-max-duration" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Error Code</label>
                            <input type="text" id="{{ key }}-error-code" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block mb-1 text-xs font-medium text-gray-700 dark:text-gray-300">Error Message</label>
                            <input type="text" id="{{ key }}-error-message" class="behavior-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex gap-3 pt-4">
            <button type="submit" id="create-btn" class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Create Batch
            </button>
            <a href="/processes" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                Cancel
            </a>
        </div>
    </form>

    <!-- Result Message -->
    <div id="result-message" class="hidden mt-4 p-4 rounded-lg"></div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { ApiClient } from '/static/src/api.js';

    const api = new ApiClient();

    // Set default dates
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setMonth(today.getMonth() - 1);

    document.getElementById('to-date').valueAsDate = today;
    document.getElementById('from-date').valueAsDate = lastMonth;

    const behaviorToggle = document.getElementById('behavior-enabled');
    const behaviorSections = document.getElementById('behavior-sections');
    const behaviorSteps = [
        { key: 'query' },
        { key: 'aggregation' },
        { key: 'render' },
    ];

    behaviorToggle.addEventListener('change', () => {
        behaviorSections.classList.toggle('hidden', !behaviorToggle.checked);
    });

    function readStepBehavior(stepKey) {
        const failPermanent = parseFloat(document.getElementById(`${stepKey}-fail-permanent`).value) || 0;
        const failTransient = parseFloat(document.getElementById(`${stepKey}-fail-transient`).value) || 0;
        const timeoutPct = parseFloat(document.getElementById(`${stepKey}-timeout`).value) || 0;
        const minDuration = parseInt(document.getElementById(`${stepKey}-min-duration`).value) || 0;
        const maxDuration = parseInt(document.getElementById(`${stepKey}-max-duration`).value) || 0;
        const errorCode = document.getElementById(`${stepKey}-error-code`).value.trim();
        const errorMessage = document.getElementById(`${stepKey}-error-message`).value.trim();

        const behavior = {};
        if (failPermanent > 0) behavior.fail_permanent_pct = failPermanent;
        if (failTransient > 0) behavior.fail_transient_pct = failTransient;
        if (timeoutPct > 0) behavior.timeout_pct = timeoutPct;
        if (minDuration > 0) behavior.min_duration_ms = minDuration;
        if (maxDuration > 0) behavior.max_duration_ms = maxDuration;
        if (errorCode) behavior.error_code = errorCode;
        if (errorMessage) behavior.error_message = errorMessage;

        return Object.keys(behavior).length ? behavior : null;
    }

    document.getElementById('process-batch-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const btn = document.getElementById('create-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Creating...';

        const data = {
            count: parseInt(document.getElementById('count').value),
            from_date: document.getElementById('from-date').value,
            to_date: document.getElementById('to-date').value,
            output_type: document.getElementById('output-type').value
        };

        if (behaviorToggle.checked) {
            const behaviorPayload = {};
            behaviorSteps.forEach(({ key }) => {
                const stepBehavior = readStepBehavior(key);
                if (stepBehavior) {
                    behaviorPayload[key] = stepBehavior;
                }
            });
            if (Object.keys(behaviorPayload).length > 0) {
                data.behavior = behaviorPayload;
            }
        }

        try {
            const result = await api.post('/processes/batch', data);

            const msgDiv = document.getElementById('result-message');
            msgDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 text-green-800 dark:bg-green-900 dark:text-green-300';
            msgDiv.innerHTML = `
                <div class="font-medium">Batch created successfully!</div>
                <div class="mt-1 text-sm">Created ${result.total} processes. Redirecting...</div>
            `;
            msgDiv.classList.remove('hidden');

            setTimeout(() => {
                window.location.href = '/processes';
            }, 1500);

        } catch (err) {
            const msgDiv = document.getElementById('result-message');
            msgDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 text-red-800 dark:bg-red-900 dark:text-red-300';
            msgDiv.innerHTML = `Error: ${err.message}`;
            msgDiv.classList.remove('hidden');

            btn.disabled = false;
            btn.textContent = originalText;
        }
    });
</script>
{% endblock %}
