{% extends 'layouts/base.html' %}

{% block title %}Process Batches - Command Bus E2E{% endblock %}

{% block content %}
<div class="mb-4 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Process Batches</h1>
        <p class="text-gray-500 dark:text-gray-400">Monitor aggregate completion of process batches</p>
    </div>
    <a href="/processes/new-batch" class="px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300">
        Create Process Batch
    </a>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow p-4 mb-6 dark:bg-gray-800">
    <form id="filter-form" class="flex flex-wrap gap-4 items-end">
        <div>
            <label for="filter-status" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Status</label>
            <select id="filter-status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="">All</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="COMPLETED">Completed</option>
                <option value="COMPLETED_WITH_FAILURES">Completed with Failures</option>
            </select>
        </div>
        <div class="flex gap-2">
            <button type="submit" class="px-4 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300">
                Apply
            </button>
            <button type="button" id="clear-filters" class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
                Clear
            </button>
        </div>
    </form>
</div>

<!-- Batches Table -->
<div class="bg-white rounded-lg shadow dark:bg-gray-800">
    <!-- Table Header -->
    <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
        <div class="text-sm text-gray-500 dark:text-gray-400">
            Showing <span id="showing-range">0-0</span> of <span id="total-count">0</span> process batches
        </div>
        <div class="flex items-center gap-2">
            <label for="page-size" class="text-sm text-gray-500 dark:text-gray-400">Page size:</label>
            <select id="page-size" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">Name</th>
                    <th scope="col" class="px-6 py-3">Status</th>
                    <th scope="col" class="px-6 py-3">Progress</th>
                    <th scope="col" class="px-6 py-3">Total</th>
                    <th scope="col" class="px-6 py-3">Completed</th>
                    <th scope="col" class="px-6 py-3">Failed</th>
                    <th scope="col" class="px-6 py-3">In Progress</th>
                    <th scope="col" class="px-6 py-3">Created</th>
                </tr>
            </thead>
            <tbody id="batches-table-body">
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        Loading process batches...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="p-4 border-t dark:border-gray-700 flex justify-between items-center">
        <button id="prev-page" disabled class="px-4 py-2 text-sm font-medium text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600">
            Previous
        </button>
        <span id="page-info" class="text-sm text-gray-500 dark:text-gray-400">Page 1 of 1</span>
        <button id="next-page" disabled class="px-4 py-2 text-sm font-medium text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600">
            Next
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { ApiClient } from '/static/src/api.js';

    const api = new ApiClient();
    let currentPage = 0;
    let pageSize = 20;
    let totalBatches = 0;

    // Status badge colors
    const statusColors = {
        'PENDING': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
        'IN_PROGRESS': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
        'COMPLETED': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
        'COMPLETED_WITH_FAILURES': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300',
    };

    // Format date
    function formatDate(isoString) {
        if (!isoString) return '-';
        const date = new Date(isoString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Get filters
    function getFilters() {
        const filters = {};
        const status = document.getElementById('filter-status').value;
        if (status) filters.status = status;
        return filters;
    }

    // Load batches
    async function loadBatches() {
        const filters = getFilters();
        const params = new URLSearchParams({
            ...filters,
            limit: pageSize,
            offset: currentPage * pageSize,
        });

        const result = await api.get(`/process-batches?${params}`);
        if (!result) return;

        totalBatches = result.total;
        renderBatches(result.batches);
        updatePagination();
    }

    // Render batches table
    function renderBatches(batches) {
        const tbody = document.getElementById('batches-table-body');

        if (batches.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        No process batches found. <a href="/processes/new-batch" class="text-blue-600 hover:underline dark:text-blue-400">Create one</a>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = batches.map(batch => `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" data-batch-id="${batch.batch_id}">
                <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                    <a href="/process-batches/${batch.batch_id}" class="hover:underline">
                        ${batch.name || batch.batch_id.substring(0, 8) + '...'}
                    </a>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[batch.status] || statusColors['PENDING']}">
                        ${batch.status}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${batch.progress_percent}%"></div>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">${batch.progress_percent.toFixed(1)}%</span>
                </td>
                <td class="px-6 py-4">${batch.total_count}</td>
                <td class="px-6 py-4 text-green-600 dark:text-green-400">${batch.completed_count}</td>
                <td class="px-6 py-4 text-red-600 dark:text-red-400">${batch.failed_count}</td>
                <td class="px-6 py-4 text-blue-600 dark:text-blue-400">${batch.in_progress_count}</td>
                <td class="px-6 py-4">${formatDate(batch.created_at)}</td>
            </tr>
        `).join('');

        // Add click handlers
        tbody.querySelectorAll('tr[data-batch-id]').forEach(row => {
            row.addEventListener('click', (e) => {
                if (e.target.tagName !== 'A') {
                    window.location.href = `/process-batches/${row.dataset.batchId}`;
                }
            });
        });
    }

    // Update pagination
    function updatePagination() {
        const totalPages = Math.ceil(totalBatches / pageSize);
        const start = currentPage * pageSize + 1;
        const end = Math.min((currentPage + 1) * pageSize, totalBatches);

        document.getElementById('showing-range').textContent = totalBatches > 0 ? `${start}-${end}` : '0-0';
        document.getElementById('total-count').textContent = totalBatches;
        document.getElementById('page-info').textContent = `Page ${currentPage + 1} of ${totalPages || 1}`;

        document.getElementById('prev-page').disabled = currentPage === 0;
        document.getElementById('next-page').disabled = currentPage >= totalPages - 1;
    }

    // Event listeners
    document.getElementById('filter-form').addEventListener('submit', (e) => {
        e.preventDefault();
        currentPage = 0;
        loadBatches();
    });

    document.getElementById('clear-filters').addEventListener('click', () => {
        document.getElementById('filter-form').reset();
        currentPage = 0;
        loadBatches();
    });

    document.getElementById('page-size').addEventListener('change', (e) => {
        pageSize = parseInt(e.target.value);
        currentPage = 0;
        loadBatches();
    });

    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            loadBatches();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(totalBatches / pageSize);
        if (currentPage < totalPages - 1) {
            currentPage++;
            loadBatches();
        }
    });

    // Initial load
    loadBatches();

    // Auto-refresh every 5 seconds for active batches
    setInterval(loadBatches, 5000);
</script>
{% endblock %}
