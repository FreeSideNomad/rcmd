{% extends 'layouts/base.html' %}

{% block title %}Create Batch - Command Bus E2E{% endblock %}

{% block content %}
<div class="mb-4">
    <nav class="flex mb-2" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 text-sm text-gray-500 dark:text-gray-400">
            <li><a href="/batches" class="hover:text-blue-600 dark:hover:text-blue-400">Batches</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-700 dark:text-gray-300">Create New</li>
        </ol>
    </nav>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Create New Batch</h1>
    <p class="text-gray-500 dark:text-gray-400">Create a batch of test commands with probabilistic behavior</p>
</div>

<!-- Batch Form -->
<div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
    <form id="batch-form" class="space-y-6">
        <!-- Batch Name -->
        <div>
            <label for="batch-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Batch Name</label>
            <input type="text" id="batch-name" value="Test Batch" placeholder="e.g., Load Test Run 1" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
        </div>

        <!-- Command Count -->
        <div>
            <label for="command-count" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Number of Commands</label>
            <input type="number" id="command-count" min="1" max="1000000" value="100" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Maximum 1,000,000 commands per batch</p>
        </div>

        <!-- Failure Probabilities -->
        <div class="p-4 bg-gray-50 rounded-lg dark:bg-gray-700">
            <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-4">Failure Probabilities</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="fail-permanent-pct" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Permanent Failure %</label>
                    <input type="number" id="fail-permanent-pct" min="0" max="100" step="0.1" value="0" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>
                <div>
                    <label for="fail-transient-pct" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Transient Failure %</label>
                    <input type="number" id="fail-transient-pct" min="0" max="100" step="0.1" value="0" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>
                <div>
                    <label for="timeout-pct" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Timeout %</label>
                    <input type="number" id="timeout-pct" min="0" max="100" step="0.1" value="0" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>
            </div>
        </div>

        <!-- Duration -->
        <div class="p-4 bg-gray-50 rounded-lg dark:bg-gray-700">
            <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-4">Success Duration (ms)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="min-duration" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Min</label>
                    <input type="number" id="min-duration" min="0" max="120000" value="50" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>
                <div>
                    <label for="max-duration" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Max</label>
                    <input type="number" id="max-duration" min="0" max="120000" value="100" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                </div>
            </div>
            <p id="duration-info" class="mt-2 text-xs text-gray-500 dark:text-gray-400">Duration uses normal distribution (mean=75ms)</p>
        </div>

        <!-- Max Attempts -->
        <div>
            <label for="max-attempts" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Max Attempts</label>
            <input type="number" id="max-attempts" min="1" max="10" value="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Maximum retry attempts before moving to TSQ</p>
        </div>

        <!-- Reply Options -->
        <div class="p-4 bg-gray-50 rounded-lg dark:bg-gray-700">
            <h3 class="text-sm font-medium text-gray-900 dark:text-white mb-4">Reply Options</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="send-response" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    <label for="send-response" class="text-sm font-medium text-gray-900 dark:text-white">Send response to reply queue</label>
                </div>
                <div id="reply-options-container" class="hidden space-y-4">
                    <div>
                        <label for="reply-to" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Reply Queue Name</label>
                        <input type="text" id="reply-to" value="e2e__replies" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white font-mono">
                    </div>
                    <div>
                        <label for="response-data" class="block mb-2 text-sm text-gray-700 dark:text-gray-300">Response Data (optional JSON)</label>
                        <textarea id="response-data" rows="2" placeholder='{"key": "value"}' class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:text-white font-mono"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expected Distribution -->
        <div id="expected-distribution" class="p-4 bg-blue-50 rounded-lg dark:bg-blue-900">
            <h4 class="text-sm font-medium text-blue-800 dark:text-blue-300 mb-3">Expected Distribution</h4>
            <div class="space-y-2">
                <div class="flex items-center">
                    <div class="w-24 text-sm text-blue-700 dark:text-blue-400">Success</div>
                    <div class="flex-1 h-4 bg-blue-100 rounded dark:bg-blue-800 overflow-hidden">
                        <div id="bar-success" class="h-full bg-green-500 transition-all duration-300" style="width: 100%"></div>
                    </div>
                    <div class="w-20 text-sm text-right text-blue-700 dark:text-blue-400"><span id="expected-success">100</span></div>
                </div>
                <div class="flex items-center">
                    <div class="w-24 text-sm text-blue-700 dark:text-blue-400">Permanent</div>
                    <div class="flex-1 h-4 bg-blue-100 rounded dark:bg-blue-800 overflow-hidden">
                        <div id="bar-permanent" class="h-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="w-20 text-sm text-right text-blue-700 dark:text-blue-400"><span id="expected-permanent">0</span></div>
                </div>
                <div class="flex items-center">
                    <div class="w-24 text-sm text-blue-700 dark:text-blue-400">Transient</div>
                    <div class="flex-1 h-4 bg-blue-100 rounded dark:bg-blue-800 overflow-hidden">
                        <div id="bar-transient" class="h-full bg-orange-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="w-20 text-sm text-right text-blue-700 dark:text-blue-400"><span id="expected-transient">0</span></div>
                </div>
                <div class="flex items-center">
                    <div class="w-24 text-sm text-blue-700 dark:text-blue-400">Timeout</div>
                    <div class="flex-1 h-4 bg-blue-100 rounded dark:bg-blue-800 overflow-hidden">
                        <div id="bar-timeout" class="h-full bg-yellow-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="w-20 text-sm text-right text-blue-700 dark:text-blue-400"><span id="expected-timeout">0</span></div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="flex gap-3">
            <button type="submit" id="create-btn" class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                Create Batch
            </button>
            <a href="/batches" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-300 dark:text-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
                Cancel
            </a>
        </div>
    </form>

    <!-- Result Message -->
    <div id="result-message" class="hidden mt-4 p-4 rounded-lg"></div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { ApiClient } from '/static/src/api.js';

    const api = new ApiClient();

    // Calculate expected outcomes based on sequential probability evaluation
    function calculateExpectedOutcomes(count, failPermanent, failTransient, timeout) {
        const permanentCount = count * (failPermanent / 100);
        const remainingAfterPermanent = count - permanentCount;

        const transientCount = remainingAfterPermanent * (failTransient / 100);
        const remainingAfterTransient = remainingAfterPermanent - transientCount;

        const timeoutCount = remainingAfterTransient * (timeout / 100);
        const successCount = remainingAfterTransient - timeoutCount;

        return {
            permanent: Math.round(permanentCount),
            transient: Math.round(transientCount),
            timeout: Math.round(timeoutCount),
            success: Math.round(successCount),
        };
    }

    // Update expected distribution
    function updateExpected() {
        const count = parseInt(document.getElementById('command-count').value) || 100;
        const failPermanent = parseFloat(document.getElementById('fail-permanent-pct').value) || 0;
        const failTransient = parseFloat(document.getElementById('fail-transient-pct').value) || 0;
        const timeout = parseFloat(document.getElementById('timeout-pct').value) || 0;

        const outcomes = calculateExpectedOutcomes(count, failPermanent, failTransient, timeout);

        // Update counts
        document.getElementById('expected-success').textContent = outcomes.success;
        document.getElementById('expected-permanent').textContent = outcomes.permanent;
        document.getElementById('expected-transient').textContent = outcomes.transient;
        document.getElementById('expected-timeout').textContent = outcomes.timeout;

        // Update bars
        document.getElementById('bar-success').style.width = (outcomes.success / count * 100) + '%';
        document.getElementById('bar-permanent').style.width = (outcomes.permanent / count * 100) + '%';
        document.getElementById('bar-transient').style.width = (outcomes.transient / count * 100) + '%';
        document.getElementById('bar-timeout').style.width = (outcomes.timeout / count * 100) + '%';
    }

    // Update duration info
    function updateDurationInfo() {
        const min = parseInt(document.getElementById('min-duration').value) || 0;
        const max = parseInt(document.getElementById('max-duration').value) || 0;
        const info = document.getElementById('duration-info');

        if (min === max) {
            info.textContent = min === 0 ? 'No delay (immediate)' : `Fixed duration: ${min}ms`;
        } else {
            const mean = (min + max) / 2;
            info.textContent = `Duration uses normal distribution (mean=${mean}ms)`;
        }
    }

    // Add event listeners for all probability inputs
    ['command-count', 'fail-permanent-pct', 'fail-transient-pct', 'timeout-pct'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateExpected);
    });

    // Add event listeners for duration inputs
    document.getElementById('min-duration').addEventListener('input', updateDurationInfo);
    document.getElementById('max-duration').addEventListener('input', updateDurationInfo);

    // Toggle reply options visibility
    document.getElementById('send-response').addEventListener('change', (e) => {
        const container = document.getElementById('reply-options-container');
        container.classList.toggle('hidden', !e.target.checked);
    });

    // Show result message
    function showResult(success, message) {
        const resultDiv = document.getElementById('result-message');
        if (success) {
            resultDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 text-green-800 dark:bg-green-900 dark:text-green-300';
        } else {
            resultDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 text-red-800 dark:bg-red-900 dark:text-red-300';
        }
        resultDiv.innerHTML = message;
        resultDiv.classList.remove('hidden');
    }

    // Form submission
    document.getElementById('batch-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const createBtn = document.getElementById('create-btn');
        createBtn.disabled = true;
        createBtn.textContent = 'Creating...';

        const name = document.getElementById('batch-name').value.trim() || 'Test Batch';
        const commandCount = parseInt(document.getElementById('command-count').value) || 100;
        const failPermanentPct = parseFloat(document.getElementById('fail-permanent-pct').value) || 0;
        const failTransientPct = parseFloat(document.getElementById('fail-transient-pct').value) || 0;
        const timeoutPct = parseFloat(document.getElementById('timeout-pct').value) || 0;
        const minDuration = parseInt(document.getElementById('min-duration').value) || 0;
        const maxDuration = parseInt(document.getElementById('max-duration').value) || 0;
        const maxAttempts = parseInt(document.getElementById('max-attempts').value) || 3;

        // Reply options
        const sendResponse = document.getElementById('send-response').checked;
        const replyTo = document.getElementById('reply-to').value.trim();
        const responseDataText = document.getElementById('response-data').value.trim();

        // Build behavior object
        const behavior = {
            fail_permanent_pct: failPermanentPct,
            fail_transient_pct: failTransientPct,
            timeout_pct: timeoutPct,
            min_duration_ms: minDuration,
            max_duration_ms: maxDuration,
        };

        // Add reply behavior options
        if (sendResponse) {
            behavior.send_response = true;
            if (responseDataText) {
                try {
                    behavior.response_data = JSON.parse(responseDataText);
                } catch (err) {
                    showResult(false, `Invalid JSON in response data: ${err.message}`);
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create Batch';
                    return;
                }
            }
        }

        const requestData = {
            name,
            command_count: commandCount,
            behavior,
            max_attempts: maxAttempts
        };

        // Add reply_to if sending response
        if (sendResponse && replyTo) {
            requestData.reply_to = replyTo;
        }

        try {
            const result = await api.post('/batches', requestData);
            if (result) {
                showResult(true, `
                    <div class="font-medium">Batch created successfully!</div>
                    <div class="mt-2 text-sm">
                        <div>Batch ID: <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">${result.batch_id}</code></div>
                        <div>Commands: <span class="font-medium">${result.total_commands}</span></div>
                    </div>
                    <div class="mt-3">
                        <a href="/batches/${result.batch_id}" class="text-blue-600 hover:underline dark:text-blue-400">View Batch Details</a>
                    </div>
                `);
            }
        } catch (err) {
            showResult(false, `Error: ${err.message}`);
        } finally {
            createBtn.disabled = false;
            createBtn.textContent = 'Create Batch';
        }
    });

    // Initialize
    updateExpected();
    updateDurationInfo();
</script>
{% endblock %}
